<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶è—åŠŸèƒ½ç·©å­˜æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”– æ”¶è—åŠŸèƒ½ç·©å­˜æ¸¬è©¦</h1>
        <p>é€™å€‹æ¸¬è©¦é é¢ç”¨ä¾†é©—è­‰æ”¶è—åŠŸèƒ½çš„ localStorage ç·©å­˜æ©Ÿåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        
        <div class="test-section">
            <h3>ğŸ“ æ¸¬è©¦æ­¥é©Ÿ</h3>
            <ol>
                <li>æ¨¡æ“¬æ·»åŠ æ”¶è—é …ç›®åˆ°ç·©å­˜</li>
                <li>å¾ç·©å­˜è®€å–æ”¶è—ç‹€æ…‹</li>
                <li>æ¸…é™¤ç·©å­˜</li>
                <li>é©—è­‰ç·©å­˜éæœŸæ©Ÿåˆ¶</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª ç·©å­˜æ“ä½œæ¸¬è©¦</h3>
            <button onclick="testAddFavorite()">æ·»åŠ æ¸¬è©¦æ”¶è—</button>
            <button onclick="testLoadFromCache()">å¾ç·©å­˜è¼‰å…¥</button>
            <button onclick="testClearCache()">æ¸…é™¤ç·©å­˜</button>
            <button onclick="testExpiredCache()">æ¸¬è©¦éæœŸç·©å­˜</button>
            <div id="cacheResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ç•¶å‰ç·©å­˜ç‹€æ…‹</h3>
            <button onclick="showCurrentCache()">é¡¯ç¤ºç•¶å‰ç·©å­˜</button>
            <div id="currentCache" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ å®Œæ•´æµç¨‹æ¸¬è©¦</h3>
            <button onclick="runFullTest()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
            <div id="fullTestResult" class="result"></div>
        </div>
    </div>

    <script>
        const TEST_USER_ID = 'test_user_123';
        
        // æ¨¡æ“¬æ·»åŠ æ”¶è—åˆ°ç·©å­˜
        function testAddFavorite() {
            try {
                const favorites = [1, 2, 3, 5, 8]; // æ¸¬è©¦æ”¶è—çš„è¡Œç¨‹ ID
                const cacheData = {
                    favorites: favorites,
                    timestamp: Date.now(),
                    userId: TEST_USER_ID
                };
                
                localStorage.setItem(`userFavorites_${TEST_USER_ID}`, JSON.stringify(cacheData));
                
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="success">âœ… æˆåŠŸæ·»åŠ  ${favorites.length} å€‹æ”¶è—åˆ°ç·©å­˜<br>æ”¶è— ID: ${favorites.join(', ')}</div>`;
            } catch (error) {
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="error">âŒ æ·»åŠ æ”¶è—å¤±æ•—: ${error.message}</div>`;
            }
        }

        // å¾ç·©å­˜è¼‰å…¥æ”¶è—
        function testLoadFromCache() {
            try {
                const cacheKey = `userFavorites_${TEST_USER_ID}`;
                const cached = localStorage.getItem(cacheKey);
                
                if (!cached) {
                    document.getElementById('cacheResult').innerHTML = 
                        `<div class="error">âŒ æ²’æœ‰æ‰¾åˆ°ç·©å­˜æ•¸æ“š</div>`;
                    return;
                }
                
                const { favorites, timestamp, userId } = JSON.parse(cached);
                const isValid = userId === TEST_USER_ID && 
                               (Date.now() - timestamp) < 24 * 60 * 60 * 1000;
                
                const ageMinutes = Math.floor((Date.now() - timestamp) / (1000 * 60));
                
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="${isValid ? 'success' : 'error'}">
                        ${isValid ? 'âœ…' : 'âŒ'} ç·©å­˜${isValid ? 'æœ‰æ•ˆ' : 'ç„¡æ•ˆ'}<br>
                        ç”¨æˆ¶ ID: ${userId}<br>
                        æ”¶è—æ•¸é‡: ${favorites.length}<br>
                        æ”¶è— ID: ${favorites.join(', ')}<br>
                        ç·©å­˜å¹´é½¡: ${ageMinutes} åˆ†é˜
                    </div>`;
            } catch (error) {
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="error">âŒ è¼‰å…¥ç·©å­˜å¤±æ•—: ${error.message}</div>`;
            }
        }

        // æ¸…é™¤ç·©å­˜
        function testClearCache() {
            try {
                localStorage.removeItem(`userFavorites_${TEST_USER_ID}`);
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="success">âœ… ç·©å­˜å·²æ¸…é™¤</div>`;
            } catch (error) {
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="error">âŒ æ¸…é™¤ç·©å­˜å¤±æ•—: ${error.message}</div>`;
            }
        }

        // æ¸¬è©¦éæœŸç·©å­˜
        function testExpiredCache() {
            try {
                const favorites = [10, 20, 30];
                const expiredTimestamp = Date.now() - (25 * 60 * 60 * 1000); // 25å°æ™‚å‰
                const cacheData = {
                    favorites: favorites,
                    timestamp: expiredTimestamp,
                    userId: TEST_USER_ID
                };
                
                localStorage.setItem(`userFavorites_${TEST_USER_ID}`, JSON.stringify(cacheData));
                
                // å˜—è©¦è¼‰å…¥éæœŸç·©å­˜
                const cached = localStorage.getItem(`userFavorites_${TEST_USER_ID}`);
                const { favorites: cachedFavorites, timestamp, userId } = JSON.parse(cached);
                const isValid = userId === TEST_USER_ID && 
                               (Date.now() - timestamp) < 24 * 60 * 60 * 1000;
                
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="${isValid ? 'error' : 'success'}">
                        ${isValid ? 'âŒ éæœŸæª¢æŸ¥å¤±æ•—' : 'âœ… éæœŸæª¢æŸ¥æ­£å¸¸'}<br>
                        ç·©å­˜æ‡‰è©²è¢«è¦–ç‚ºç„¡æ•ˆ<br>
                        å¯¦éš›ç‹€æ…‹: ${isValid ? 'æœ‰æ•ˆ' : 'ç„¡æ•ˆ'}
                    </div>`;
            } catch (error) {
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="error">âŒ éæœŸæ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
            }
        }

        // é¡¯ç¤ºç•¶å‰ç·©å­˜
        function showCurrentCache() {
            try {
                const allKeys = Object.keys(localStorage).filter(key => key.startsWith('userFavorites_'));
                
                if (allKeys.length === 0) {
                    document.getElementById('currentCache').innerHTML = 
                        `<div>ğŸ“­ æ²’æœ‰æ”¶è—ç·©å­˜æ•¸æ“š</div>`;
                    return;
                }
                
                let html = '<div>ğŸ“¦ ç•¶å‰ç·©å­˜æ•¸æ“š:<br><br>';
                allKeys.forEach(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        const ageHours = Math.floor((Date.now() - data.timestamp) / (1000 * 60 * 60));
                        html += `<strong>${key}:</strong><br>`;
                        html += `- ç”¨æˆ¶: ${data.userId}<br>`;
                        html += `- æ”¶è—æ•¸: ${data.favorites.length}<br>`;
                        html += `- å¹´é½¡: ${ageHours} å°æ™‚<br><br>`;
                    } catch (e) {
                        html += `<strong>${key}:</strong> è§£æå¤±æ•—<br><br>`;
                    }
                });
                html += '</div>';
                
                document.getElementById('currentCache').innerHTML = html;
            } catch (error) {
                document.getElementById('currentCache').innerHTML = 
                    `<div class="error">âŒ é¡¯ç¤ºç·©å­˜å¤±æ•—: ${error.message}</div>`;
            }
        }

        // åŸ·è¡Œå®Œæ•´æ¸¬è©¦
        function runFullTest() {
            const results = [];
            
            try {
                // 1. æ¸…é™¤ç¾æœ‰ç·©å­˜
                localStorage.removeItem(`userFavorites_${TEST_USER_ID}`);
                results.push('âœ… æ­¥é©Ÿ 1: æ¸…é™¤ç¾æœ‰ç·©å­˜');
                
                // 2. æ·»åŠ æ–°ç·©å­˜
                const testFavorites = [100, 200, 300];
                const cacheData = {
                    favorites: testFavorites,
                    timestamp: Date.now(),
                    userId: TEST_USER_ID
                };
                localStorage.setItem(`userFavorites_${TEST_USER_ID}`, JSON.stringify(cacheData));
                results.push('âœ… æ­¥é©Ÿ 2: æ·»åŠ æ¸¬è©¦ç·©å­˜');
                
                // 3. é©—è­‰ç·©å­˜è¼‰å…¥
                const cached = localStorage.getItem(`userFavorites_${TEST_USER_ID}`);
                const parsed = JSON.parse(cached);
                const isValid = parsed.userId === TEST_USER_ID && 
                               (Date.now() - parsed.timestamp) < 24 * 60 * 60 * 1000;
                
                if (isValid && parsed.favorites.length === 3) {
                    results.push('âœ… æ­¥é©Ÿ 3: ç·©å­˜è¼‰å…¥é©—è­‰æˆåŠŸ');
                } else {
                    results.push('âŒ æ­¥é©Ÿ 3: ç·©å­˜è¼‰å…¥é©—è­‰å¤±æ•—');
                }
                
                // 4. æ¸¬è©¦ç·©å­˜æ›´æ–°
                const updatedFavorites = [100, 200, 300, 400];
                const updatedCacheData = {
                    favorites: updatedFavorites,
                    timestamp: Date.now(),
                    userId: TEST_USER_ID
                };
                localStorage.setItem(`userFavorites_${TEST_USER_ID}`, JSON.stringify(updatedCacheData));
                results.push('âœ… æ­¥é©Ÿ 4: ç·©å­˜æ›´æ–°æˆåŠŸ');
                
                // 5. æœ€çµ‚é©—è­‰
                const finalCached = localStorage.getItem(`userFavorites_${TEST_USER_ID}`);
                const finalParsed = JSON.parse(finalCached);
                
                if (finalParsed.favorites.length === 4) {
                    results.push('âœ… æ­¥é©Ÿ 5: æœ€çµ‚é©—è­‰æˆåŠŸ');
                    results.push('ğŸ‰ å®Œæ•´æ¸¬è©¦é€šéï¼');
                } else {
                    results.push('âŒ æ­¥é©Ÿ 5: æœ€çµ‚é©—è­‰å¤±æ•—');
                }
                
            } catch (error) {
                results.push(`âŒ æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
            
            document.getElementById('fullTestResult').innerHTML = 
                `<div>${results.join('<br>')}</div>`;
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç•¶å‰ç·©å­˜ç‹€æ…‹
        window.onload = function() {
            showCurrentCache();
        };
    </script>
</body>
</html>
