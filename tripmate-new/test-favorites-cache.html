<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>收藏功能緩存測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔖 收藏功能緩存測試</h1>
        <p>這個測試頁面用來驗證收藏功能的 localStorage 緩存機制是否正常工作。</p>
        
        <div class="test-section">
            <h3>📝 測試步驟</h3>
            <ol>
                <li>模擬添加收藏項目到緩存</li>
                <li>從緩存讀取收藏狀態</li>
                <li>清除緩存</li>
                <li>驗證緩存過期機制</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>🧪 緩存操作測試</h3>
            <button onclick="testAddFavorite()">添加測試收藏</button>
            <button onclick="testLoadFromCache()">從緩存載入</button>
            <button onclick="testClearCache()">清除緩存</button>
            <button onclick="testExpiredCache()">測試過期緩存</button>
            <div id="cacheResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>📊 當前緩存狀態</h3>
            <button onclick="showCurrentCache()">顯示當前緩存</button>
            <div id="currentCache" class="result"></div>
        </div>

        <div class="test-section">
            <h3>🔄 完整流程測試</h3>
            <button onclick="runFullTest()">執行完整測試</button>
            <div id="fullTestResult" class="result"></div>
        </div>
    </div>

    <script>
        const TEST_USER_ID = 'test_user_123';
        
        // 模擬添加收藏到緩存
        function testAddFavorite() {
            try {
                const favorites = [1, 2, 3, 5, 8]; // 測試收藏的行程 ID
                const cacheData = {
                    favorites: favorites,
                    timestamp: Date.now(),
                    userId: TEST_USER_ID
                };
                
                localStorage.setItem(`userFavorites_${TEST_USER_ID}`, JSON.stringify(cacheData));
                
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="success">✅ 成功添加 ${favorites.length} 個收藏到緩存<br>收藏 ID: ${favorites.join(', ')}</div>`;
            } catch (error) {
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="error">❌ 添加收藏失敗: ${error.message}</div>`;
            }
        }

        // 從緩存載入收藏
        function testLoadFromCache() {
            try {
                const cacheKey = `userFavorites_${TEST_USER_ID}`;
                const cached = localStorage.getItem(cacheKey);
                
                if (!cached) {
                    document.getElementById('cacheResult').innerHTML = 
                        `<div class="error">❌ 沒有找到緩存數據</div>`;
                    return;
                }
                
                const { favorites, timestamp, userId } = JSON.parse(cached);
                const isValid = userId === TEST_USER_ID && 
                               (Date.now() - timestamp) < 24 * 60 * 60 * 1000;
                
                const ageMinutes = Math.floor((Date.now() - timestamp) / (1000 * 60));
                
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="${isValid ? 'success' : 'error'}">
                        ${isValid ? '✅' : '❌'} 緩存${isValid ? '有效' : '無效'}<br>
                        用戶 ID: ${userId}<br>
                        收藏數量: ${favorites.length}<br>
                        收藏 ID: ${favorites.join(', ')}<br>
                        緩存年齡: ${ageMinutes} 分鐘
                    </div>`;
            } catch (error) {
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="error">❌ 載入緩存失敗: ${error.message}</div>`;
            }
        }

        // 清除緩存
        function testClearCache() {
            try {
                localStorage.removeItem(`userFavorites_${TEST_USER_ID}`);
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="success">✅ 緩存已清除</div>`;
            } catch (error) {
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="error">❌ 清除緩存失敗: ${error.message}</div>`;
            }
        }

        // 測試過期緩存
        function testExpiredCache() {
            try {
                const favorites = [10, 20, 30];
                const expiredTimestamp = Date.now() - (25 * 60 * 60 * 1000); // 25小時前
                const cacheData = {
                    favorites: favorites,
                    timestamp: expiredTimestamp,
                    userId: TEST_USER_ID
                };
                
                localStorage.setItem(`userFavorites_${TEST_USER_ID}`, JSON.stringify(cacheData));
                
                // 嘗試載入過期緩存
                const cached = localStorage.getItem(`userFavorites_${TEST_USER_ID}`);
                const { favorites: cachedFavorites, timestamp, userId } = JSON.parse(cached);
                const isValid = userId === TEST_USER_ID && 
                               (Date.now() - timestamp) < 24 * 60 * 60 * 1000;
                
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="${isValid ? 'error' : 'success'}">
                        ${isValid ? '❌ 過期檢查失敗' : '✅ 過期檢查正常'}<br>
                        緩存應該被視為無效<br>
                        實際狀態: ${isValid ? '有效' : '無效'}
                    </div>`;
            } catch (error) {
                document.getElementById('cacheResult').innerHTML = 
                    `<div class="error">❌ 過期測試失敗: ${error.message}</div>`;
            }
        }

        // 顯示當前緩存
        function showCurrentCache() {
            try {
                const allKeys = Object.keys(localStorage).filter(key => key.startsWith('userFavorites_'));
                
                if (allKeys.length === 0) {
                    document.getElementById('currentCache').innerHTML = 
                        `<div>📭 沒有收藏緩存數據</div>`;
                    return;
                }
                
                let html = '<div>📦 當前緩存數據:<br><br>';
                allKeys.forEach(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        const ageHours = Math.floor((Date.now() - data.timestamp) / (1000 * 60 * 60));
                        html += `<strong>${key}:</strong><br>`;
                        html += `- 用戶: ${data.userId}<br>`;
                        html += `- 收藏數: ${data.favorites.length}<br>`;
                        html += `- 年齡: ${ageHours} 小時<br><br>`;
                    } catch (e) {
                        html += `<strong>${key}:</strong> 解析失敗<br><br>`;
                    }
                });
                html += '</div>';
                
                document.getElementById('currentCache').innerHTML = html;
            } catch (error) {
                document.getElementById('currentCache').innerHTML = 
                    `<div class="error">❌ 顯示緩存失敗: ${error.message}</div>`;
            }
        }

        // 執行完整測試
        function runFullTest() {
            const results = [];
            
            try {
                // 1. 清除現有緩存
                localStorage.removeItem(`userFavorites_${TEST_USER_ID}`);
                results.push('✅ 步驟 1: 清除現有緩存');
                
                // 2. 添加新緩存
                const testFavorites = [100, 200, 300];
                const cacheData = {
                    favorites: testFavorites,
                    timestamp: Date.now(),
                    userId: TEST_USER_ID
                };
                localStorage.setItem(`userFavorites_${TEST_USER_ID}`, JSON.stringify(cacheData));
                results.push('✅ 步驟 2: 添加測試緩存');
                
                // 3. 驗證緩存載入
                const cached = localStorage.getItem(`userFavorites_${TEST_USER_ID}`);
                const parsed = JSON.parse(cached);
                const isValid = parsed.userId === TEST_USER_ID && 
                               (Date.now() - parsed.timestamp) < 24 * 60 * 60 * 1000;
                
                if (isValid && parsed.favorites.length === 3) {
                    results.push('✅ 步驟 3: 緩存載入驗證成功');
                } else {
                    results.push('❌ 步驟 3: 緩存載入驗證失敗');
                }
                
                // 4. 測試緩存更新
                const updatedFavorites = [100, 200, 300, 400];
                const updatedCacheData = {
                    favorites: updatedFavorites,
                    timestamp: Date.now(),
                    userId: TEST_USER_ID
                };
                localStorage.setItem(`userFavorites_${TEST_USER_ID}`, JSON.stringify(updatedCacheData));
                results.push('✅ 步驟 4: 緩存更新成功');
                
                // 5. 最終驗證
                const finalCached = localStorage.getItem(`userFavorites_${TEST_USER_ID}`);
                const finalParsed = JSON.parse(finalCached);
                
                if (finalParsed.favorites.length === 4) {
                    results.push('✅ 步驟 5: 最終驗證成功');
                    results.push('🎉 完整測試通過！');
                } else {
                    results.push('❌ 步驟 5: 最終驗證失敗');
                }
                
            } catch (error) {
                results.push(`❌ 測試過程中發生錯誤: ${error.message}`);
            }
            
            document.getElementById('fullTestResult').innerHTML = 
                `<div>${results.join('<br>')}</div>`;
        }

        // 頁面載入時顯示當前緩存狀態
        window.onload = function() {
            showCurrentCache();
        };
    </script>
</body>
</html>
